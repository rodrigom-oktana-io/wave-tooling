{
  "Join_ServiceCaseServiceTask": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "WhatId"
      ],
      "left": "Join_CaseAccount",
      "left_key": [
        "Id"
      ],
      "right_select": [
        "ActivityLastModifiedDate"
      ],
      "right": "Compute_Extract_Task",
      "relationship": "Task"
    }
  },
  "Register_ActivityOwner_Case": {
    "action": "sfdcRegister",
    "parameters": {
      "SFDCtoken": "SFDCtoken",
      "name": "ServiceActivity",
      "alias": "<ServiceActivity>",
      "source": "Filter_Activities",
      "folderid": "<folderId>"
    }
  },
  "Join_CaseAccount": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Case_CSAT_Mea",
      "left_key": [
        "AccountId"
      ],
      "right_select": [
        "Id",
        "Name",
        "BillingCountry",
        "Industry"
      ],
      "right": "Extract_Account",
      "relationship": "Account"
    }
  },
  "Extract_Contact": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "Name"
        },
        {
          "name": "Id"
        }
      ],
      "object": "Contact"
    }
  },
  "Extract_Opportunity": {
    "action": "sfdcDigest",
    "parameters": {
      "SFDCtoken": "SFDCtoken",
      "fields": [
        {
          "name": "Id"
        },
        {
          "name": "AccountId"
        },
        {
          "name": "OwnerId"
        },
        {
          "name": "Name"
        },
        {
          "defaultValue": "N/A",
          "name": "StageName"
        },
        {
          "defaultValue": "N/A",
          "name": "LeadSource"
        },
        {
          "name": "IsWon"
        },
        {
          "name": "IsClosed"
        },
        {
          "defaultValue": "N/A",
          "name": "ForecastCategory"
        },
        {
          "defaultValue": "N/A",
          "name": "ForecastCategoryName"
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "CreatedDate__c",
          "isYearEndFiscalYear": false
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "CloseDate",
          "isYearEndFiscalYear": false
        },
        {
          "name": "Amount"
        },
        {
          "name": "CreatedById"
        }
      ],
      "object": "Opportunity"
    }
  },
  "Extract_Task": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "Id"
        },
        {
          "name": "CallObject"
        },
        {
          "name": "CallDurationInSeconds"
        },
        {
          "defaultValue": "N/A",
          "name": "CallDisposition"
        },
        {
          "defaultValue": "N/A",
          "name": "CallType"
        },
        {
          "name": "OwnerId"
        },
        {
          "defaultValue": "N/A",
          "name": "Status"
        },
        {
          "defaultValue": "N/A",
          "name": "Priority"
        },
        {
          "name": "IsClosed"
        },
        {
          "defaultValue": "N/A",
          "name": "TaskSubtype"
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "CreatedDate",
          "isYearEndFiscalYear": false
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "ActivityDate",
          "isYearEndFiscalYear": false
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "LastModifiedDate",
          "isYearEndFiscalYear": false
        },
        {
          "defaultValue": "N/A",
          "name": "Subject"
        },
        {
          "name": "WhatId"
        }
      ],
      "object": "Task"
    }
  },
  "Join_CaseAccountContact": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "computeJoin_ServiceCaseTask",
      "left_key": [
        "ContactId"
      ],
      "right_select": [
        "Name",
        "Id"
      ],
      "right": "Extract_Contact",
      "relationship": "Contact"
    }
  },
  "Compute_Extract_Task": {
    "action": "computeRelative",
    "parameters": {
      "partitionBy": [
        "WhatId"
      ],
      "orderBy": [
        {
          "name": "LastModifiedDate",
          "direction": "asc"
        }
      ],
      "source": "Extract_Task",
      "computedFields": [
        {
          "expression": {
            "sourceField": "LastModifiedDate",
            "default": "current()",
            "offset": "first()"
          },
          "name": "ActivityLastModifiedDate",
          "description": "ActivityLastModifiedDate",
          "label": "ActivityLastModifiedDate"
        }
      ]
    }
  },
  "Extract_User": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "CallCenterId"
        },
        {
          "name": "Name"
        },
        {
          "name": "UserRoleId"
        },
        {
          "name": "Id"
        }
      ],
      "object": "User"
    }
  },
  "Extract_Case": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "CSAT__c",
          "type": "Text"
        },
        {
          "name": "AccountId"
        },
        {
          "name": "ContactId"
        },
        {
          "name": "OwnerId"
        },
        {
          "name": "Id"
        },
        {
          "defaultValue": "N/A",
          "name": "Origin"
        },
        {
          "defaultValue": "N/A",
          "name": "Reason"
        },
        {
          "defaultValue": "N/A",
          "name": "Type"
        },
        {
          "name": "IsClosed"
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "ClosedDate",
          "isYearEndFiscalYear": false
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "CreatedDate",
          "isYearEndFiscalYear": false
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "LastModifiedDate",
          "isYearEndFiscalYear": false
        },
        {
          "name": "IsEscalated"
        },
        {
          "name": "First_Contact_Close__c"
        },
        {
          "defaultValue": "N/A",
          "name": "SLA_Type__c"
        },
        {
          "defaultValue": "N/A",
          "name": "Status"
        },
        {
          "name": "MilestoneStatus"
        },
        {
          "defaultValue": "N/A",
          "name": "Product_Family_KB__c"
        },
        {
          "defaultValue": "N/A",
          "name": "Priority"
        },
        {
          "name": "CaseNumber"
        }
      ],
      "object": "Case"
    }
  },
  "Join_CaseAccountContactUser": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Join_CaseAccountContact",
      "left_key": [
        "OwnerId"
      ],
      "right_select": [
        "CallCenterId",
        "Name",
        "Id",
        "UserRoleId",
        "Type"
      ],
      "right": "Add_Fields_To_User",
      "relationship": "Owner"
    }
  },
  "Join_OpportunityRecordTypeAccount": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Extract_Opportunity",
      "left_key": [
        "AccountId"
      ],
      "right_select": [
        "Id",
        "Name",
        "BillingCountry",
        "Industry"
      ],
      "right": "Extract_Account",
      "relationship": "Account"
    }
  },
  "Case_CSAT_Mea": {
    "action": "dim2mea",
    "parameters": {
      "measure": "CSAT",
      "measureDefault": "-999",
      "source": "compute_CalculatedCaseDuration",
      "dimension": "CSAT__c",
      "measureType": "long"
    }
  },
  "compute_CalculatedCaseDuration": {
    "action": "computeExpression",
    "parameters": {
      "source": "compute_CurrentDateForCase",
      "computedFields": [
        {
          "defaultValue": "0",
          "precision": 18,
          "name": "DurationCalculatedField",
          "saqlExpression": "case  when ('IsClosed' == \"true\") then ('ClosedDate_sec_epoch' - 'CreatedDate_sec_epoch')/86400   else ('CurrentDate_sec_epoch' - 'CreatedDate_sec_epoch')/86400  end",
          "scale": 2,
          "label": "Case Duration",
          "type": "Numeric"
        }
      ],
      "mergeWithSource": true
    }
  },
  "Join_ActivityOwner_Case": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Join_ActivityOwner",
      "left_key": [
        "WhatId"
      ],
      "right_select": [
        "Id",
        "Origin",
        "Reason",
        "Type",
        "IsClosed",
        "ClosedDate",
        "CreatedDate",
        "SLA_Type__c",
        "Status",
        "Product_Family_KB__c",
        "Priority",
        "CaseNumber",
        "Account.Name",
        "DurationCalculatedField",
        "Role.Name",
        "CurrentDate"
      ],
      "right": "Join_CaseAccountContactUserUserRole",
      "relationship": "Case"
    }
  },
  "compute_CurrentDateForCase": {
    "action": "computeExpression",
    "parameters": {
      "source": "Extract_Case",
      "computedFields": [
        {
          "format": "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
          "name": "CurrentDate",
          "saqlExpression": "now()",
          "label": "CurrentDate",
          "type": "Date"
        },
        {
          "format": "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
          "name": "ValidToWithNow",
          "saqlExpression": "case  when ('IsClosed' == \"true\") then toDate('ClosedDate', \"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\") else now()  end",
          "label": "ValidToWithNow",
          "type": "Date"
        }
      ],
      "mergeWithSource": true
    }
  },
  "Extract_Account": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "Id"
        },
        {
          "name": "Name"
        },
        {
          "defaultValue": "N/A",
          "name": "BillingCountry"
        },
        {
          "defaultValue": "N/A",
          "name": "Industry"
        }
      ],
      "object": "Account"
    }
  },
  "Handle_Only_Task": {
    "action": "computeExpression",
    "parameters": {
      "source": "Join_ActivityOwner_Case",
      "computedFields": [
        {
          "name": "IsActivity",
          "saqlExpression": "case when 'Case.Id' is null then \"No\" else \"Yes\" end",
          "label": "Is Activity",
          "type": "Text"
        },
        {
          "name": "IsCall",
          "saqlExpression": "case when CallDurationInSeconds > 0 then \"Yes\" else \"No\" end",
          "label": "Is Call",
          "type": "Text"
        },
        {
          "name": "ActivityType",
          "saqlExpression": "TaskSubtype",
          "label": "ActivityType",
          "type": "Text"
        },
        {
          "name": "ActivityIsClosed",
          "saqlExpression": "case when 'IsClosed' == \"true\" then \"Completed\" else \"Open\" end",
          "label": "Activity Is Closed",
          "type": "Text"
        }
      ],
      "mergeWithSource": true
    }
  },
  "Add_Fields_To_User": {
    "action": "computeExpression",
    "parameters": {
      "source": "Extract_User",
      "computedFields": [
        {
          "name": "Type",
          "saqlExpression": "\"User\"",
          "label": "Type",
          "type": "Text"
        }
      ],
      "mergeWithSource": true
    }
  },
  "Join_OpportunityRecordTypeAccountCase": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "AccountId"
      ],
      "left": "Join_OpportunityRecordTypeAccount",
      "left_key": [
        "AccountId"
      ],
      "right_select": [
        "Id",
        "CaseNumber",
        "IsEscalated",
        "Priority"
      ],
      "right": "compute_CalculatedCaseDuration",
      "relationship": "Case"
    }
  },
  "computeJoin_ServiceCaseTask": {
    "action": "computeExpression",
    "parameters": {
      "source": "Join_ServiceCaseServiceTask",
      "computedFields": [
        {
          "defaultValue": "0",
          "precision": 18,
          "name": "sum_last_activity",
          "saqlExpression": "case when ('Task.ActivityLastModifiedDate_sec_epoch' >= 'LastModifiedDate_sec_epoch') then ('CurrentDate_sec_epoch' - 'Task.ActivityLastModifiedDate_sec_epoch')/86400 when ('LastModifiedDate_sec_epoch' >= 'Task.ActivityLastModifiedDate_sec_epoch') then ('CurrentDate_sec_epoch' - 'LastModifiedDate_sec_epoch')/86400  else ('CurrentDate_sec_epoch' - 'LastModifiedDate_sec_epoch')/86400 end",
          "scale": 2,
          "label": "Last LastModifiedDate",
          "type": "Numeric"
        }
      ],
      "mergeWithSource": true
    }
  },
  "Join_ActivityOwner": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Extract_Task",
      "left_key": [
        "OwnerId"
      ],
      "right_select": [
        "Name",
        "Id",
        "UserRoleId"
      ],
      "right": "Extract_User",
      "relationship": "Owner"
    }
  },
  "Extract_UserRole": {
    "action": "sfdcDigest",
    "parameters": {
      "fields": [
        {
          "name": "Id"
        },
        {
          "name": "Name"
        },
        {
          "name": "ParentRoleId"
        },
        {
          "fiscalMonthOffset": 0,
          "firstDayOfWeek": "0",
          "name": "LastModifiedDate",
          "isYearEndFiscalYear": false
        },
        {
          "name": "LastModifiedById"
        },
        {
          "name": "SystemModstamp"
        }
      ],
      "object": "UserRole"
    }
  },
  "Join_CaseAccountContactUserUserRole": {
    "action": "augment",
    "parameters": {
      "right_key": [
        "Id"
      ],
      "left": "Join_CaseAccountContactUser",
      "left_key": [
        "Owner.UserRoleId"
      ],
      "right_select": [
        "Name",
        "ParentRoleId"
      ],
      "right": "Extract_UserRole",
      "relationship": "Role"
    }
  },
  "Filter_Activities": {
    "action": "filter",
    "parameters": {
      "filter": "IsActivity:EQ:Yes",
      "source": "Handle_Only_Task"
    }
  },
  "Register_Case": {
    "action": "sfdcRegister",
    "parameters": {
      "SFDCtoken": "SFDCtoken",
      "name": "ServiceCase",
      "alias": "<ServiceCase>",
      "source": "Join_CaseAccountContactUserUserRole",
      "folderid": "<folderId>"
    }
  },
  "Register_Opportunity": {
    "action": "sfdcRegister",
    "parameters": {
      "SFDCtoken": "SFDCtoken",
      "name": "ServiceOpportunities",
      "alias": "<ServiceOpportunity>",
      "source": "Join_OpportunityRecordTypeAccountCase",
      "folderid": "<folderId>"
    }
  }
}
